<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Where Am I? Estimating Location In Runescape With The Mini-Map | The Horenberger Zone</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Where Am I? Estimating Location In Runescape With The Mini-Map" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Table of Contents Solving Runescape So I Can Finally Quit If The Mini-Map Is Oriented North If The Mini-Map Is Not Oriented North Extracting Angle Information From The Compass By Transforming Between Features Rotating The Mini-Map Conclusion Appendix" />
<meta property="og:description" content="Table of Contents Solving Runescape So I Can Finally Quit If The Mini-Map Is Oriented North If The Mini-Map Is Not Oriented North Extracting Angle Information From The Compass By Transforming Between Features Rotating The Mini-Map Conclusion Appendix" />
<link rel="canonical" href="http://localhost:4000/2022/03/04/runescapelocationfinding.html" />
<meta property="og:url" content="http://localhost:4000/2022/03/04/runescapelocationfinding.html" />
<meta property="og:site_name" content="The Horenberger Zone" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-03-04T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Where Am I? Estimating Location In Runescape With The Mini-Map" />
<script type="application/ld+json">
{"headline":"Where Am I? Estimating Location In Runescape With The Mini-Map","dateModified":"2022-03-04T00:00:00-05:00","datePublished":"2022-03-04T00:00:00-05:00","description":"Table of Contents Solving Runescape So I Can Finally Quit If The Mini-Map Is Oriented North If The Mini-Map Is Not Oriented North Extracting Angle Information From The Compass By Transforming Between Features Rotating The Mini-Map Conclusion Appendix","url":"http://localhost:4000/2022/03/04/runescapelocationfinding.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2022/03/04/runescapelocationfinding.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="The Horenberger Zone" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
          delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
          ]}
        );
      });
    </script>
  
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">The Horenberger Zone</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about.html">Bio</a><a class="page-link" href="/contact.html">Contact</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Where Am I? Estimating Location In Runescape With The Mini-Map</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2022-03-04T00:00:00-05:00" itemprop="datePublished">Mar 4, 2022
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="table-of-contents">Table of Contents</h2>
<ul>
  <li><a href="#Solving-Runescape-So-I-Can-Finally-Quit">Solving Runescape So I Can Finally Quit</a></li>
  <li><a href="#If-The-Mini-Map-Is-Oriented-North">If The Mini-Map Is Oriented North</a></li>
  <li><a href="#If-The-Mini-Map-Is-Not-Oriented-North">If The Mini-Map Is Not Oriented North</a></li>
  <li><a href="#Extracting-Angle-Information-From-The-Compass-By-Transforming-Between-Features">Extracting Angle Information From The Compass By Transforming Between Features</a></li>
  <li><a href="#Rotating-The-Mini-Map">Rotating The Mini-Map</a></li>
  <li><a href="#Conclusion">Conclusion</a></li>
  <li><a href="#Appendix">Appendix</a></li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># see appendix for more info
</span><span class="o">%</span><span class="n">run</span> <span class="n">blog</span><span class="o">/</span><span class="n">utilities</span><span class="p">.</span><span class="n">ipynb</span>
</code></pre></div></div>

<h1 id="solving-runescape-so-i-can-finally-quit-">Solving Runescape So I Can Finally Quit <a name="Solving-Runescape-So-I-Can-Finally-Quit"></a></h1>

<p>Runescape is a boring video game for losers. In the game, your location is represented to you in both a world map and a mini-map. My goal was to estimate the player’s location on the world map using only the mini-map. Real-time location estimation is the first step in breaking the game so that it can play itself and we can all go home.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">world_map_lumbridge</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s">'/images/rotation_estimation/world_map_lumbridge.png'</span><span class="p">)</span>
<span class="n">north_oriented_map</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s">'/images/rotation_estimation/north_oriented_map.png'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">imshow</span><span class="p">(</span><span class="n">north_oriented_map</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="s">'The player</span><span class="se">\'</span><span class="s">s minimap'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">imshow</span><span class="p">(</span><span class="n">world_map_lumbridge</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="s">'A small piece of the world map'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/images/rotation_estimation/rotation_estimation_3_0.png" alt="png" /></p>

<h2 id="if-the-mini-map-is-oriented-north-">If The Mini-Map Is Oriented North <a name="If-The-Mini-Map-Is-Oriented-North"></a></h2>
<p>So we’re given an image of the mini-map, and we estimate the corresponding location on the world map. If the mini-map is north-facing, this is a fairly simple problem. We can simply take the map from the mini-map and template search to find it on the world map.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cropped_mini_map</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s">'/images/rotation_estimation/cropped_mini_map.png'</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

<span class="c1"># template search
</span><span class="n">method</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">TM_CCOEFF_NORMED</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">matchTemplate</span><span class="p">(</span><span class="n">cropped_mini_map</span><span class="p">,</span> <span class="n">world_map_lumbridge</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
<span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">min_loc</span><span class="p">,</span> <span class="n">max_loc</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">minMaxLoc</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="c1"># plot the estimated match
</span><span class="n">template_match_plotted</span> <span class="o">=</span> <span class="n">world_map_lumbridge</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">cv</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">template_match_plotted</span><span class="p">,</span>
             <span class="p">(</span><span class="n">max_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
             <span class="p">(</span><span class="n">max_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cropped_mini_map</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">cropped_mini_map</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
             <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">show_images</span><span class="p">(</span><span class="n">cropped_mini_map</span><span class="p">,</span> <span class="n">template_match_plotted</span><span class="p">,</span> <span class="s">'The cropped mini-map'</span><span class="p">,</span> <span class="s">'The corresponding template match (Good)'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/images/rotation_estimation/rotation_estimation_5_0.png" alt="png" /></p>

<h2 id="if-the-mini-map-is-not-oriented-north-">If The Mini-Map Is Not Oriented North <a name="If-The-Mini-Map-Is-Not-Oriented-North"></a></h2>

<p>In this case, we can’t apply a template search right away. The map is crooked, so we won’t get good detections</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">crooked_mini_map</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s">'/images/rotation_estimation/crooked_mini_map.png'</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

<span class="c1"># template search
</span><span class="n">method</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">TM_CCOEFF_NORMED</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">matchTemplate</span><span class="p">(</span><span class="n">crooked_mini_map</span><span class="p">,</span> <span class="n">world_map_lumbridge</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
<span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">min_loc</span><span class="p">,</span> <span class="n">max_loc</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">minMaxLoc</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="c1"># plot the estimated match
</span><span class="n">result_plotted</span> <span class="o">=</span> <span class="n">world_map_lumbridge</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">cv</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">result_plotted</span><span class="p">,</span>
             <span class="p">(</span><span class="n">max_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
             <span class="p">(</span><span class="n">max_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">crooked_mini_map</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">crooked_mini_map</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
             <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">show_images</span><span class="p">(</span><span class="n">crooked_mini_map</span><span class="p">,</span> <span class="n">result_plotted</span><span class="p">,</span> <span class="s">'The rotated mini-map'</span><span class="p">,</span> <span class="s">'The corresponding template match (Bad)'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/images/rotation_estimation/rotation_estimation_7_0.png" alt="png" /></p>

<p>So, how could we convert a rotated mini-map back into a north-facing minimap?</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">north_east_oriented_map</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s">'/images/rotation_estimation/north_east_oriented_map.png'</span><span class="p">)</span>
<span class="n">show_images</span><span class="p">(</span><span class="n">north_east_oriented_map</span><span class="p">,</span> <span class="n">north_oriented_map</span><span class="p">,</span> <span class="s">'The map we are given'</span><span class="p">,</span> <span class="s">'The map we want to convert to'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/images/rotation_estimation/rotation_estimation_9_0.png" alt="png" /></p>

<h3 id="extracting-angle-information-from-the-compass-by-transforming-between-features-">Extracting Angle Information From The Compass By Transforming Between Features <a name="Extracting-Angle-Information-From-The-Compass-By-Transforming-Between-Features"></a></h3>

<p>If we can determine the angle of rotation, then we can rotate the mini-map image to match its north-facing counterpart. We can estimate the angle of rotation using the compass. The first step is to detect “features” on the rotated compass and correspond them to features on the north-facing compass. First we detect features using the SIFT algorithm.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">compass_north</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s">'/images/rotation_estimation/compass_north.png'</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cv</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
<span class="n">compass_north_east</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s">'/images/rotation_estimation/compass_northeast.png'</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cv</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>

<span class="c1"># Initiate SIFT detector
</span><span class="n">sift</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">SIFT_create</span><span class="p">()</span>
<span class="c1"># find the keypoints and descriptors with SIFT
</span><span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span> <span class="o">=</span> <span class="n">sift</span><span class="p">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">compass_north_east</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
<span class="n">kp2</span><span class="p">,</span> <span class="n">des2</span> <span class="o">=</span> <span class="n">sift</span><span class="p">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">compass_north</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="n">compass_north_east_features</span> <span class="o">=</span> <span class="n">compass_north_east</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">compass_north_features</span> <span class="o">=</span> <span class="n">compass_north</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">compass_north_east_features</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">drawKeypoints</span><span class="p">(</span><span class="n">compass_north_east</span><span class="p">,</span> <span class="n">kp1</span><span class="p">,</span> <span class="n">compass_north_east_features</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">cv</span><span class="p">.</span><span class="n">DRAW_MATCHES_FLAGS_DEFAULT</span><span class="p">)</span>
<span class="n">compass_north_features</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">drawKeypoints</span><span class="p">(</span><span class="n">compass_north</span><span class="p">,</span> <span class="n">kp2</span><span class="p">,</span> <span class="n">compass_north_features</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">cv</span><span class="p">.</span><span class="n">DRAW_MATCHES_FLAGS_DEFAULT</span><span class="p">)</span>

<span class="n">show_images</span><span class="p">(</span><span class="n">compass_north_features</span><span class="p">,</span> <span class="n">compass_north_east_features</span><span class="p">,</span> <span class="s">'Features for north compass'</span><span class="p">,</span> <span class="s">'Features for north-east compass'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/images/rotation_estimation/rotation_estimation_11_0.png" alt="png" /></p>

<p>Next we pair the features between the compasses using Flann matcher, which takes advantage of the gradient information represented in SIFT features. We won’t go into details on how this works. We use Flann to get acceptable matches according to some threshold</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">FLANN_INDEX_KDTREE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">index_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">FLANN_INDEX_KDTREE</span><span class="p">,</span> <span class="n">trees</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">search_params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">checks</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">flann</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">FlannBasedMatcher</span><span class="p">(</span><span class="n">index_params</span><span class="p">,</span> <span class="n">search_params</span><span class="p">)</span>
<span class="n">matches</span> <span class="o">=</span> <span class="n">flann</span><span class="p">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">lowe_ratio_threshold</span> <span class="o">=</span> <span class="mf">0.7</span>

<span class="n">good_matches</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">lowe_ratio_threshold</span> <span class="o">*</span> <span class="n">n</span><span class="p">.</span><span class="n">distance</span><span class="p">:</span>
        <span class="n">good_matches</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        
<span class="n">img_matches</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">empty</span><span class="p">(</span>
    <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">compass_north_east</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">compass_north</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">compass_north_east</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">compass_north</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="n">cv</span><span class="p">.</span><span class="n">drawMatches</span><span class="p">(</span><span class="n">compass_north_east</span><span class="p">,</span> <span class="n">kp1</span><span class="p">,</span> <span class="n">compass_north</span><span class="p">,</span> <span class="n">kp2</span><span class="p">,</span>
               <span class="n">good_matches</span><span class="p">,</span> <span class="n">img_matches</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">cv</span><span class="p">.</span><span class="n">DrawMatchesFlags_NOT_DRAW_SINGLE_POINTS</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_matches</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;matplotlib.image.AxesImage at 0x7fc6f4a09d30&gt;
</code></pre></div></div>

<p><img src="/images/rotation_estimation/rotation_estimation_13_1.png" alt="png" /></p>

<p>Now we want to calculate an explicit translation between the paired features of the two compasses. We can do this if we make an assumption that the compasses are related by an affine function, i.e. a mix of scaling, rotation, and translation. In reality, we should find out that the transformation is almost entirely rotation with very little scaling.</p>

<p>A 2D affine transformation involving a scaling by $s_x, s_y$, shearing by $c_x, c_y$, rotation by $\theta$, and a translation by $x_t, y_t$, can be represented in 3D as a linear transformation with the help of homogenous coordinates,</p>

\[M = 
  \left[ {\begin{array}{cc}
    s_x\cos{\theta} &amp; -c_x\sin{\theta}  &amp; x\\
    c_y\sin{\theta} &amp; s_y\cos{\theta}  &amp; y\\
    0 &amp; 0 &amp; 1\\
  \end{array} } \right]\]

<p>So that we can map a feature at $(x,y)$ on the original image to the corresponding feature at $(x’, y’)$ on the final image</p>

\[M 
    \left[ {\begin{array}{cc}
    x\\
    y\\
    1\\
  \end{array} } \right]
    =
    \left[ {\begin{array}{cc}
    x'\\
    y'\\
    1'\\
  \end{array} } \right]\]

<p>We will approximate the best of these matrices for mapping between the features of the two compasses using OpenCV’s EstimateAffine2D. Then we can simply calculate $\theta$ from the matrix we obtain.</p>

<p>EstimateAffine2D uses Random Sample Consensus, or RANSAC, to estimate the affine transformation from our limited set of sample points.</p>

<p>##</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">src_pts</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp1</span><span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="n">queryIdx</span><span class="p">].</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good_matches</span><span class="p">]).</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">dst_pts</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([</span><span class="n">kp2</span><span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="n">trainIdx</span><span class="p">].</span><span class="n">pt</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">good_matches</span><span class="p">]).</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">M</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">estimateAffine2D</span><span class="p">(</span><span class="n">src_pts</span><span class="p">,</span> <span class="n">dst_pts</span><span class="p">,</span> <span class="n">cv</span><span class="p">.</span><span class="n">RANSAC</span><span class="p">)</span>

<span class="n">M</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array([[  0.57565154,   0.85025771, -14.11907287],
       [ -0.8060638 ,   0.58425459,  44.51285597]])
</code></pre></div></div>

<p>Wow, very cool. Let’s assume that $c_x, s_x \approxeq 1$. Then we can calculate our angle of rotation as $\arctan{(\sin{\theta},\cos{\theta})}=\arctan{(-M_{01}, M_{00})}$</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">angle</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-0.9756521224680054
</code></pre></div></div>

<p>This is about $.3\pi$ radians. Let’s get convert that to English.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">angle_degrees</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">*</span> <span class="p">(</span><span class="mf">180.0</span><span class="o">/</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="p">)</span>
<span class="n">angle_degrees</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-55.90074889039763
</code></pre></div></div>

<p>Very nice. Looks like we’ve got our angle, boys. I’m a little worried about the simplifying assumptions we made (i.e. that $c_x, s_x \approxeq 1$), but I’ve found that in practice this does a pretty darn good job of consistently approximating the angle. It also doesn’t matter, since our mini-map correction will use the whole translation matrix.</p>

<h3 id="rotating-the-mini-map-">Rotating The Mini-Map <a name="Rotating-The-Mini-Map"></a></h3>

<p>Okay, let’s bring it home now. We need to use the calculated transformation to rotate our mini-map so that it is once again north-facing. Let’s try it with our compass first.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">compass_north_east</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">corrected_compass</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">compass_north_east</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">))</span>

<span class="n">show_images</span><span class="p">(</span><span class="n">compass_north_east</span><span class="p">,</span> <span class="n">corrected_compass</span><span class="p">,</span> <span class="s">'The compass we were given'</span><span class="p">,</span> <span class="s">'The corrected compass we computed'</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/images/rotation_estimation/rotation_estimation_21_0.png" alt="png" /></p>

<p>Great, now let’s try the mini-map</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">crooked_mini_map</span> <span class="o">=</span> <span class="n">load_image</span><span class="p">(</span><span class="s">'/images/rotation_estimation/crooked_mini_map.png'</span><span class="p">)</span>
<span class="n">corrected_mini_map</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">warpAffine</span><span class="p">(</span><span class="n">crooked_mini_map</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">))</span>

<span class="n">show_images</span><span class="p">(</span><span class="n">crooked_mini_map</span><span class="p">,</span> <span class="n">corrected_mini_map</span><span class="p">,</span> <span class="s">'The mini-map we were given'</span><span class="p">,</span> <span class="s">'The corrected mini-map we computed'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/images/rotation_estimation/rotation_estimation_23_0.png" alt="png" /></p>

<p>I resized to make sure the mini-map is actually the same size as the compass we used to calculate the transformation. This makes the procedure more reliable in the face of weird translation shenanigans.</p>

<p>Finally, we can resize to the proper scale for a template search, trim off the gross bits on the corners, and figure out where in the world we are</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">corrected_mini_map</span><span class="p">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">trim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">np</span><span class="p">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rows</span><span class="o">*</span><span class="n">rows</span> <span class="o">+</span> <span class="n">cols</span><span class="o">*</span><span class="n">cols</span><span class="p">)</span> <span class="o">-</span> <span class="n">rows</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
<span class="n">final_mini_map</span> <span class="o">=</span> <span class="n">corrected_mini_map</span><span class="p">[</span><span class="n">trim</span><span class="p">:(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">trim</span><span class="p">),</span> <span class="n">trim</span><span class="p">:(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">trim</span><span class="p">)]</span>
<span class="n">final_mini_map</span> <span class="o">=</span> <span class="n">scale_img</span><span class="p">(</span><span class="n">final_mini_map</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>

<span class="c1"># template search
</span><span class="n">method</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">TM_CCOEFF_NORMED</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">matchTemplate</span><span class="p">(</span><span class="n">final_mini_map</span><span class="p">,</span> <span class="n">world_map_lumbridge</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
<span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">min_loc</span><span class="p">,</span> <span class="n">max_loc</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">minMaxLoc</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="c1"># plot the estimated match
</span><span class="n">template_match_plotted</span> <span class="o">=</span> <span class="n">world_map_lumbridge</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">cv</span><span class="p">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">template_match_plotted</span><span class="p">,</span>
             <span class="p">(</span><span class="n">max_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
             <span class="p">(</span><span class="n">max_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">final_mini_map</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">final_mini_map</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
             <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">show_images</span><span class="p">(</span><span class="n">final_mini_map</span><span class="p">,</span> <span class="n">template_match_plotted</span><span class="p">,</span> <span class="s">'The corrected mini-map'</span><span class="p">,</span> <span class="s">'The corresponding template match (Good)'</span><span class="p">)</span>
</code></pre></div></div>

<p><img src="/images/rotation_estimation/rotation_estimation_25_0.png" alt="png" /></p>

<h1 id="conclusion-">Conclusion <a name="Conclusion"></a></h1>

<p>Runescape is a horrible game. All you do is grind repetitive tasks to gain experience and gold pieces. Anyone could play it. Why can’t a computer? I’m trying to design a representation of the game that makes it playable by a computer in a human-like way. To do this, I’m breaking the game into conceptual components that I can model mathematically. For example, here we have established that the player is a point on a two-dimensional surface, and that the coordinates of both the player and world locations can be established using computer vision along with a copy of the world map.</p>

<p>The next thing I will be exploring is using object detection to detect interactable components of the screen, such as “seeing” that there is a goblin which I can attack. I’ll also be working on the Ratcatchers quest in OSRS because my stupid computer can’t do it for me.</p>

<h1 id="appendix-">Appendix <a name="Appendix"></a></h1>

<h2 id="blogutilitiesipynb">blog/utilities.ipynb</h2>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span> <span class="k">as</span> <span class="n">cv</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">os</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scale_img</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">scale_percent</span><span class="p">):</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_percent</span><span class="p">)</span>
    <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale_percent</span><span class="p">)</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cv</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv</span><span class="p">.</span><span class="n">INTER_AREA</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="n">img_dir</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cv</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_dir</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span>  <span class="n">cv</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">scale_img</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">show_images</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">title1</span><span class="p">,</span> <span class="n">title2</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">imshow</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="n">title1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">imshow</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">set_title</span><span class="p">(</span><span class="n">title2</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="n">wspace</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">make_grayscale_and_resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="n">new_img</span> <span class="o">=</span> <span class="n">cv</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv</span><span class="p">.</span><span class="n">COLOR_RGB2GRAYSCALE</span><span class="p">)</span>
    <span class="n">new_img</span> <span class="o">=</span> <span class="n">scale_img</span><span class="p">(</span><span class="n">new_img</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_img</span>
</code></pre></div></div>

  </div><a class="u-url" href="/2022/03/04/runescapelocationfinding.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">The Horenberger Zone</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">The Horenberger Zone</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list">
  <li><a href="https://github.com/horenbergerb"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">horenbergerb</span></a></li><li><a href="https://www.twitter.com/BeauHorenberger"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">BeauHorenberger</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Cite me in your thesis</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
